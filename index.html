<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheat Plant Detection</title>

  <!-- Correct PyScript CSS -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2025.11.2/core.css"/>

  <!-- Correct PyScript core -->
  <script type="module" src="https://pyscript.net/releases/2025.11.2/core.js"></script>

  <link rel="stylesheet" href="style.css">

  <!-- Correct PyScript 2025 config -->
  <script type="py-config">
  {
    "permissions": ["readFiles"]
  }
  </script>
</head>

<body>

  <header>
    <h1>Wheat Plant Detection</h1>
    <p>Use this AI to classify your wheat plant into one of 7 categories.</p>
  </header>

  <div class="upload-section">
    <div class="button-row">
      <label for="imageInput" class="upload-label">Choose Image</label>
      <button id="classifyBtn" class="upload-btn">Classify</button>
    </div>

    <input type="file" id="imageInput" accept="image/*" style="display:none;">

    <div id="preview-container">
      <img id="preview" style="display:none; max-width:300px; max-height:300px;">
    </div>
  </div>

  <div id="result" class="result-badge"></div>

<py-script>
import js
import numpy as np
from PIL import Image
import onnxruntime as ort
from pyscript import when

# Load ONNX model
session = ort.InferenceSession("wheat_mobilenet.onnx")

categories = [
    'Rust', 'Pests', 'Mildew', 'Blight_Spot',
    'Smut_Rot', 'Fusarium_Blast', 'Healthy'
]

selected_file = None

def preprocess_image(image_bytes):
    # Load image from bytes
    img = Image.open(io.BytesIO(image_bytes)).convert("RGB")
    img = img.resize((160, 160))
    arr = np.array(img).astype(np.float32) / 255.0
    arr = np.expand_dims(arr, axis=0)  # batch dimension
    return arr

def classifier(image_bytes):
    input_tensor = preprocess_image(image_bytes)
    input_name = session.get_inputs()[0].name
    outputs = session.run(None, {input_name: input_tensor})
    pred_class = np.argmax(outputs[0])
    return categories[pred_class]

@when("change", "#imageInput")
def preview_image(event):
    global selected_file
    selected_file = event.target.files.item(0)
    if not selected_file:
        js.console.log("No file received.")
        return

    reader = js.FileReader.new()
    def on_load(e):
        img = js.document.getElementById("preview")
        img.src = e.target.result
        img.style.display = "block"
    reader.onload = on_load
    reader.readAsDataURL(selected_file)

@when("click", "#classifyBtn")
async def classify_image(event):
    global selected_file
    if not selected_file:
        js.document.getElementById("result").innerText = "No image selected!"
        return

    buf = await selected_file.arrayBuffer()
    uint8 = js.Uint8Array.new(buf)
    image_bytes = bytes(uint8.to_py())

    category = classifier(image_bytes)
    js.document.getElementById("result").innerText = f"Predicted: {category}"
</py-script>

</body>
</html>
