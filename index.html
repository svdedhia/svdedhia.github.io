<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheat Plant Detection</title>

  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css"/>
  <script type="module" src="https://pyscript.net/releases/2025.11.2/core.js"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <h1>Wheat Plant Detection</h1>
    <p>Use this AI to classify your wheat plant into one of 7 categories.</p>
  </header>

  <div class="upload-section">
    <div class="button-row">
      <label for="imageInput" class="upload-label">Choose Image</label>
      <button id="classifyBtn" class="upload-btn">Classify</button>
    </div>

    <input type="file" id="imageInput" accept="image/*" style="display:none;">

    <div id="preview-container">
      <img id="preview" style="display:none; max-width:300px; max-height:300px;">
    </div>
  </div>

  <div id="result" class="result-badge"></div>

  <!-- PyScript -->
  <py-script>
import js
from pyscript import when
import random
import asyncio

# categories
categories = [
    'Rust', 'Pests', 'Mildew', 'Blight_Spot',
    'Smut_Rot', 'Fusarium_Blast', 'Healthy'
]

selected_file = None

# mock classifier
def classifier(image_bytes: bytes):
    return random.choice(categories)

# → Handle image preview
@when("change", "#imageInput")
async def preview_image(event):
    global selected_file
    selected_file = event.target.files[0]
    if not selected_file:
        return

    data_url = await selected_file.toDataURL()
    preview = js.document.getElementById("preview")
    preview.src = data_url
    preview.style.display = "block"

# → Handle classification button press
@when("click", "#classifyBtn")
async def classify_image(event):
    global selected_file
    if not selected_file:
        js.document.getElementById("result").innerText = "No image selected!"
        return

    # Convert JS ArrayBuffer → Python bytes
    buf = await selected_file.arrayBuffer()
    uint8 = js.Uint8Array.new(buf)     # JS typed array
    image_bytes = bytes(uint8.to_py()) # convert to Python bytes

    category = classifier(image_bytes)
    js.document.getElementById("result").innerText = f"Predicted: {category}"
  </py-script>

</body>
</html>
