<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wheat Plant Detection</title>

  <link rel="stylesheet" href="https://pyscript.net/releases/2025.11.2/core.css"/>
  <script type="module" src="https://pyscript.net/releases/2025.11.2/core.js"></script>

  <!-- ONNX Runtime Web -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

  <link rel="stylesheet" href="style.css">

  <script type="py-config">
  {
    "permissions": ["readFiles"]
  }
  </script>
</head>
<body>

<header>
  <h1>Wheat Plant Detection</h1>
  <p>Use this AI to classify your wheat plant into one of 7 categories.</p>
</header>

<div class="upload-section">
  <div class="button-row">
    <label for="imageInput" class="upload-label">Choose Image</label>
    <button id="classifyBtn" class="upload-btn">Classify</button>
  </div>

  <input type="file" id="imageInput" accept="image/*" style="display:none;">

  <div id="preview-container">
    <img id="preview" style="display:none; max-width:300px; max-height:300px;">
  </div>
</div>

<div id="result" class="result-badge"></div>

<!-- PyScript for preprocessing -->
<py-script>
  import js
  from pyscript import when
  import io
  import base64
  import asyncio
  import pyodide
  
  selected_file = None
  
  # Load packages first
  async def main():
    await pyodide.loadPackage("numpy")
    await pyodide.loadPackage("pillow")
    import numpy as np
    from PIL import Image
    print(np.arange(5))

  # Run main to load packages
  asyncio.create_task(main())
  
  @when("change", "#imageInput")
  def preview_image(event):
    global selected_file
    selected_file = event.target.files.item(0)
    if not selected_file:
        js.console.log("No file received.")
        return

  reader = js.FileReader.new()
  def on_load(e):
        img = js.document.getElementById("preview")
        img.src = e.target.result
        img.style.display = "block"
  reader.onload = on_load
  reader.readAsDataURL(selected_file)

  # Preprocess image and send to JS
  def preprocess_for_onnx(image_bytes):
    import numpy as np
    from PIL import Image

    img = Image.open(io.BytesIO(image_bytes)).convert("RGB")
    img = img.resize((160, 160))  # match ONNX model input
    arr = np.array(img).astype(np.float32) / 255.0
    arr = np.expand_dims(arr, 0)  # batch dim
    flat = arr.flatten().tolist()
    return flat
</py-script>

<script>
const categories = [
  'Rust', 'Pests', 'Mildew', 'Blight_Spot',
  'Smut_Rot', 'Fusarium_Blast', 'Healthy'
];

let session;
async function loadModel() {
    session = await ort.InferenceSession.create('wheat_mobilenet.onnx');
}
loadModel();

document.getElementById("classifyBtn").addEventListener("click", async () => {
    if (!selected_file) {
        document.getElementById("result").innerText = "No image selected!";
        return;
    }

    // Get image bytes from PyScript
    const buf = await selected_file.arrayBuffer();
    const uint8 = new Uint8Array(buf);

    // Call PyScript preprocessing
    const preprocessed = await pyodide.runPythonAsync(`
import io
from js import uint8
from __main__ import preprocess_for_onnx
preprocess_for_onnx(bytes(uint8.to_py()))
`);

    const inputTensor = new ort.Tensor('float32', new Float32Array(preprocessed), [1,160,160,3]);
    const output = await session.run({input: inputTensor});
    const predClass = output.output.data.indexOf(Math.max(...output.output.data));
    document.getElementById("result").innerText = `Predicted: ${categories[predClass]}`;
});
</script>

</body>
</html>
